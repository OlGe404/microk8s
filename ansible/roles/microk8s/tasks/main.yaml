---
- name: install microk8s
  become: true
  snap:
    name: microk8s
    classic: true
    channel: "{{ microk8s.version }}"

- name: add {{ lookup('env', 'USER') }} to microk8s group
  become: true
  user:
    name: "{{ lookup('env', 'USER') }}"
    groups: ["microk8s"]
    append: true

- name: create microk8s config
  block:
    - name: create {{ lookup('env', 'HOME') }}/.kube dir
      file:
        dest: "{{ lookup('env', 'HOME') }}/.kube"
        state: directory
        mode: "0755"

    - name: create {{ lookup('env', 'HOME') }}/.kube/microk8s_config file
      shell: >
        microk8s config |
        tee {{ lookup('env', 'HOME') }}/.kube/microk8s_config
      args:
        creates: "{{ lookup('env', 'HOME') }}/.kube/microk8s_config"

    - name: set file permissions
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube/microk8s_config"
        owner: "{{ lookup('env', 'USER') }}"
        mode: "0600"

- name: set aliases for common microk8s commands
  become: true
  block:
    - name: create {{ lookup('env', 'HOME') }}/.bash_aliases
      copy:
        content: ""
        dest: "{{ lookup('env', 'HOME') }}/.bash_aliases"
        force: false
        mode: "0644"
        owner: "{{ lookup('env', 'USER') }}"

    - name: append aliases to {{ lookup('env', 'HOME') }}/.bash_aliases
      blockinfile:
        path: "{{ lookup('env', 'HOME') }}/.bash_aliases"
        marker: "# {mark} ansible managed microk8s aliases"
        block: |-
          alias m8s='microk8s'
          alias mk='microk8s kubectl'
          alias mkgp='microk8s kubectl get pods'
          alias mksys='microk8s kubectl config \
            set-context --current \
            --namespace kube-system'

- name: wait for microk8s to be ready
  command: /snap/bin/microk8s.status --wait-ready
  changed_when: false

- name: include when vxlan.fix=true
  include_tasks:
    file: fix-vxlan.yaml
  when: vxlan.fix|bool

- name: enable add-ons {{ microk8s.add_ons | join(', ') }}
  become: true
  command: "microk8s enable {{ item }}"
  with_items: "{{ microk8s.add_ons }}"
  changed_when: false
